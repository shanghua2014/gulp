<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>兑换码</title>
    <link rel="shortcut icon"type="image/x-icon" href="/img/favicon.ico"media="screen" />
    <link rel="stylesheet" href="./css/bootstrap.3.3.7.min.css">
    <link rel="stylesheet" href="./css/base.css" />
    <script src="./js/jquery.min.js"></script>
</head>
<body>
    <div class="logos wid100 fl">
        <div class="logo1 tal fl">
            <img src="./img/logo.png" class="img-responsive center-block" />
        </div>
        <div class="logo2 tar fr">
            <a href="#"><img src="./img/logo2.png" class="img-responsive center-block" /></a>
        </div>
    </div>
    <div class="row">
        <img src="./img/bg.png" alt="" class="img-responsive wid100">
    </div>
    <div class="row form">
        <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10 col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1">
            <input type="text" class="mob wid100" placeholder="请输入兑换码" id="code" />
        </div>
        <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10 col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1">
            <input type="text" class="mob code wid100" maxlength=11 placeholder="请输入您的手机号" id="mob" />
        </div>
        <div class="col-xs-6 col-sm-8 col-md-8 col-lg-10 col-xs-offset-3 col-sm-offset-2 col-md-offset-2 col-lg-offset-1">
            <input type="button" class="submit wid100" id="submit" value="兑换" />
            </div>
        </div>
    </div>
    <div class="row font">
        <div class="col-xs-12 col-sm-10 col-md-10 col-lg-10 col-xs-offset-0 col-sm-offset-1 col-md-offset-1 col-lg-offset-1">
            <p>兑换码使用说明：</p>
            <br/>
            <p>
            兑换视为同意《用户使用条款协议》<br/>
            兑换码有有效期，请留意使用时间，请在兑换有效期内使用，过期失效。<br/>
            兑换码不可兑换现金。请注意保密，若发生盗用、泄露、遗失等问题不予调换与退款。<br/>
            </p>
        </div>
    </div>
    <script>    
        $('#submit').click(function () {
            var mobValue = $.trim($('#mob').val());
            var codeValue = $.trim($('#code').val());
            if (!codeValue) {
                bodyAddElement('兑换码有误'); return;
            }
            
            var datas = 'code='+codeValue+'&platform=16';
            $.ajax({
            method : 'post',
            async : 'faslse',
            url : 'https://beta.huanxi.com/qat/index/getTicketInfo',
            data: datas,
            success : function (res) {
                if (res.code == 2000) {
                    var hasCode = 1;
                    var isStart = 1;
                    var nowtime = res.result.nowtime;
                    var activity_start_time = res.result.activity_start_time;
                    var activity_end_time = res.result.activity_end_time;
                    var ticket_start_time = res.result.ticket_start_time;
                    var ticket_end_time = res.result.ticket_end_time;
                    var num = res.result.num;
                    if (nowtime < ticket_start_time) {
                        isStart = 0;
                        bodyAddElement('本次活动还未开始'); return;
                    }
                    if (nowtime >= ticket_end_time) {
                        bodyAddElement('本次活动已结束'); return;
                    }
                    if (nowtime < activity_start_time) {
                        isStart = 0;
                        bodyAddElement('本次活动还未开始'); return;
                    }
                    if (nowtime >= activity_end_time) {
                        bodyAddElement('本次活动已结束'); return;
                    }
                    if (nowtime >= activity_start_time && nowtime < activity_end_time) {
                        if (num <= 0) {
                            hasCode = 0;
                            bodyAddElement('兑换券已被领取完了'); return;
                        }
                    }
                    if (!isStart) {bodyAddElement('本次活动还未开始'); return;}
                    if (!hasCode) {bodyAddElement('兑换券已被领取完了'); return;}

                    if (!/^(\+86)*0*1[2-9]\d{9}$/.test($.trim(mobValue))) {
                        bodyAddElement('手机号码有误'); return;
                    }
                    $.ajax({
                        method:'post',
                        url : 'https://beta.huanxi.com/qat/index/fixedTicket',
                        data : datas+='&phone='+mobValue,
                        async : 'faslse',
                        success : function (res) {
                            if (res.code == 2000) {
                                bodyAddElement(res.result.msgDetail1, res.result.msgDetail2, 'https://qam.huanxi.com/player.shtml');
                            } else {
                                bodyAddElement(res.message);
                            }
                        }
                    });
                } else {
                    bodyAddElement(res.message);
                }
            }
        });

            
        });

        function bodyAddElement (str, str2, href) {
            var str2 = typeof str2 == 'undefined' ? '' : str2;
            var href = typeof href == 'undefined' ? 'javascript:;' : href;
            $('body').append(pop(str, str2, href));
        }
        function pop (msg1, msg2, href) {
            var msg2 = typeof msg2 == 'undefined' ? '' : msg2;
            return '<div class="mask" id="mask"></div><div class="alert pa tac col-xs-10 col-sm-10 col-md-10 col-xs-offset-1 col-sm-offset-1 col-md-offset-1" id="maskInfo"><h1>'+msg1+'</h1><p>'+msg2+'</p><a href="'+href+'" id="confirm" class="block wid100">确定</div></div><script>mask();<\/script>';
        }
        function mask () {
            $("#confirm").click(function () {
                $('#mask').remove();
                $('#maskInfo').remove();
            });
            $(window).on('resize',function () {
                mask();
            });
            $('#mask').css({
                width:$('body').width(),
                height:$('body').height()
            });
        }
    </script>
</body>
</html>